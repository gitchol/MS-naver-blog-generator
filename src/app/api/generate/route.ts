import { GoogleGenerativeAI } from '@google/generative-ai';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    const { prompt, category, keywords, contentType } = await request.json();

    if (!prompt || !category || !keywords || !contentType || !Array.isArray(keywords) || keywords.length < 3) {
      return NextResponse.json({ error: 'Prompt, category, contentType, and at least 3 keywords are required' }, { status: 400 });
    }

    // Create content-type specific prompt with keywords
    const keywordString = keywords.join(', ');
    
    const contentTypePrompts = {
      professional: {
        structure: {
          paragraph1: "ì „ë¬¸ì  ë°°ê²½ ë° í˜„í™© ë¶„ì„ - ê¸€ ìš”ì•½ ì œì‹œ, ì—…ê³„ ì „ë¬¸ ì§€ì‹ê³¼ ì‹¤ë¬´ ê²½í—˜ ê¸°ë°˜. í‚¤ì›Œë“œë¥¼ ë¬¸ìž¥ ì„œë‘ì— ë°°ì¹˜í•˜ì—¬ SEO ìµœì í™”. ì‹¤ì œ í•©ê²© ì‚¬ë¡€ì™€ í•™ì›ì˜ ì „ë¬¸ì„± ì–´í•„. ë¬¸ìžì—´ ë‚´ì— ì†Œì œëª©ê³¼ ë³¸ë¬¸ì„ í¬í•¨í•˜ì—¬ êµ¬ì¡°í™”. ì˜ë¬¸ ì „ê³µëª…ì„ ë³‘ê¸°í•˜ì—¬ êµ­ì œì  ë§¥ë½ ì œê³µ (350-400ìž)",
          paragraph2: "í•µì‹¬ ë‚´ìš© ì„¤ëª… - [1], [2] ë“± ë‹¨ê³„ë³„ êµ¬ì¡°í™”ëœ ì„¤ëª…, êµ¬ì²´ì  ì‚¬ë¡€ì™€ ì „ë¬¸ ìš©ì–´ í¬í•¨. í‚¤ì›Œë“œë¥¼ ì¤‘ê°„ ë¶€ë¶„ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë°˜ë³µ ë°°ì¹˜. í•™ìƒë“¤ì˜ ì‹¤ë ¥ í–¥ìƒê³¼ í•©ê²©ë¥  ë°ì´í„° ì–¸ê¸‰. ì¤‘ê°„ì— 'ðŸ“Œ í•µì‹¬ ìš”ì•½' ë°•ìŠ¤ í˜•íƒœì˜ ìš”ì•½ ì •ë³´ í¬í•¨. ë¬¸ìžì—´ ë‚´ì— ì†Œì œëª©ê³¼ ë³¸ë¬¸ì„ í¬í•¨í•˜ì—¬ êµ¬ì¡°í™” (400-450ìž)",
          paragraph3: "ì‹¤ë¬´ ì ìš© ë°©ì•ˆ ë° ì „ë¬¸ê°€ ì¡°ì–¸ - í‚¤ì›Œë“œë¥¼ ê²°ë¡  ë¶€ë¶„ì— ìž¬ì°¨ ê°•ì¡°í•˜ì—¬ SEO íš¨ê³¼ ê·¹ëŒ€í™”. í•™ì›ì˜ ì°¨ë³„í™”ëœ ì»¤ë¦¬í˜ëŸ¼ê³¼ ê°œì¸ë³„ ë§žì¶¤ ì§€ë„ ë°©ì‹ ì–´í•„. 'ì •ë¦¬í•˜ë©´', 'ì˜¤ëŠ˜ ê¸€ ì •ë¦¬' ë“±ìœ¼ë¡œ ë§ˆë¬´ë¦¬. ë¬¸ìžì—´ ë‚´ì— ì†Œì œëª©ê³¼ ë³¸ë¬¸ì„ í¬í•¨í•˜ì—¬ êµ¬ì¡°í™” (350-400ìž)"
        },
        tone: "ì „ë¬¸ê°€ê°€ ì‹¤ë¬´ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ êµìœ¡í•˜ëŠ” í†¤. ì§§ì€ ë¬¸ìž¥ê³¼ ê¸´ ë¬¸ìž¥ì„ í˜¼ìš©í•˜ì—¬ ë¦¬ë“¬ê° ì¡°ì„±. ì „ë¬¸ ìš©ì–´ë¥¼ ì‚¬ìš©í•˜ë˜ ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…. ê°•ì¡° í‘œí˜„ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆížˆ ì„žì–´ ë‹¨ì¡°ë¡œì›€ ë°©ì§€. í•™ì›ì˜ ì „ë¬¸ì„±ê³¼ ì‹¤ì œ ì„±ê³¼ë¥¼ ìžì—°ìŠ¤ëŸ½ê²Œ ì–´í•„. ê° ë¬¸ë‹¨ ë‚´ì— ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ì½ê¸° íŽ¸í•˜ê²Œ êµ¬ì„±.",
        format: "ì œëª©ì— ì£¼ì œ ìš”ì•½ í¬í•¨, ë³¸ë¬¸ ì‹œìž‘ì— 'ì˜¤ëŠ˜ ê¸€ ìš”ì•½' êµ¬ì¡°, ë‹¨ê³„ë³„ ë²ˆí˜¸ ë§¤ê¸°ê¸° ([1], [2]), ê° ë¬¸ë‹¨ ë‚´ì— ì†Œì œëª© í¬í•¨, ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì— 'ðŸ“Œ í•µì‹¬ ìš”ì•½' ë°•ìŠ¤ í¬í•¨, ì˜ë¬¸ ì „ê³µëª… ë³‘ê¸°, í‚¤ì›Œë“œ SEO ë°°ì¹˜(ì„œë‘/ì¤‘ê°„/ê²°ë¡ ), í•™ì› ì°¨ë³„í™” í¬ì¸íŠ¸ ì–¸ê¸‰, ë§ˆì§€ë§‰ì— ì •ë¦¬ ë¬¸êµ¬",
        examples: "êµ¬ì²´ì ì¸ ì¼€ì´ìŠ¤ ìŠ¤í„°ë””, ì‹¤ë¬´ íŒ, ë‹¨ê³„ë³„ ê°€ì´ë“œë¼ì¸, ì „ë¬¸ê°€ ì¸ì‚¬ì´íŠ¸, í•µì‹¬ ìš”ì•½ ë°•ìŠ¤, í•©ê²© ì‚¬ë¡€ ë° í†µê³„, í•™ì› ì»¤ë¦¬í˜ëŸ¼ ê°•ì "
      },
      qna: {
        structure: {
          paragraph1: "í•µì‹¬ ì§ˆë¬¸ 1 (Key Question 1) ì œì‹œ ë° ì´ì— ëŒ€í•œ ì¹œê·¼í•˜ê³  ê°ì •ì ì¸ ì–´ì¡°ì˜ ë‹µë³€. 'â—† Q1: ì§ˆë¬¸ë‚´ìš©' í˜•íƒœë¡œ ì‹œìž‘í•˜ì—¬ ë‹µë³€ ì œê³µ. í‚¤ì›Œë“œë¥¼ ì§ˆë¬¸ê³¼ ë‹µë³€ ì´ˆë°˜ì— ë°°ì¹˜. í•™ì›ì˜ ì‹¤ì œ ì§€ë„ ê²½í—˜ê³¼ í•™ìƒ ì„±ê³¼ ì–¸ê¸‰. ì§§ì€ ë¬¸ìž¥ê³¼ ê¸´ ë¬¸ìž¥ í˜¼ìš©ìœ¼ë¡œ ë¦¬ë“¬ê° ì¡°ì„± (450-550ìž)",
          paragraph2: "í•µì‹¬ ì§ˆë¬¸ 2 (Key Question 2) ì œì‹œ ë° ì´ì— ëŒ€í•œ ë‹µë³€. 'â—† Q2: ì§ˆë¬¸ë‚´ìš©' í˜•íƒœë¡œ ì‹œìž‘í•˜ì—¬ ë‹µë³€ ì œê³µ. í‚¤ì›Œë“œë¥¼ ë‹µë³€ ì¤‘ê°„ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë°˜ë³µ. í•™ì›ì˜ ì°¨ë³„í™”ëœ êµìœ¡ ë°©ì‹ê³¼ ê°œë³„ ë§žì¶¤ ì§€ë„ ì–´í•„. ê°•ì¡° í‘œí˜„ê³¼ êµ¬ì–´ì²´ ì ì ˆížˆ í™œìš© (450-550ìž)",
          paragraph3: "í•µì‹¬ ì§ˆë¬¸ 3 (Key Question 3) ì œì‹œ ë° ì´ì— ëŒ€í•œ ë‹µë³€. 'â—† Q3: ì§ˆë¬¸ë‚´ìš©' í˜•íƒœë¡œ ì‹œìž‘í•˜ì—¬ ë‹µë³€ ì œê³µ. í‚¤ì›Œë“œë¥¼ ë§ˆë¬´ë¦¬ ë¶€ë¶„ì— ìž¬ê°•ì¡°. í•™ì›ì˜ í•©ê²©ë¥ ê³¼ í•™ìƒë“¤ì˜ ì‹¤ë ¥ í–¥ìƒ ì‚¬ë¡€ ì–¸ê¸‰. ì˜ë¬¸ ì „ê³µëª… ë³‘ê¸°ë¡œ êµ­ì œì  ë§¥ë½ ì œê³µ (450-550ìž)"
        },
        tone: "ì¹œê·¼í•˜ê³  ê°ì •ì ì¸ ì–´ì¡°ë¡œ, ì‹¤ì œ ê²½í—˜ì„ ì§ì ‘ì ìœ¼ë¡œ ë“œëŸ¬ë‚´ì§€ ì•Šê³ ë„ ê³µê°ê³¼ ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ë°©ì‹. ì§§ì€ ë¬¸ìž¥ê³¼ ê¸´ ë¬¸ìž¥ì„ í˜¼ìš©í•˜ì—¬ ë¦¬ë“¬ê° ì¡°ì„±. ê°•ì¡° í‘œí˜„ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆížˆ ì„žì–´ ë‹¨ì¡°ë¡œì›€ ë°©ì§€. í•™ì›ì˜ ì „ë¬¸ì„±ê³¼ í•™ìƒ ì„±ê³¼ë¥¼ ìžì—°ìŠ¤ëŸ½ê²Œ ì–´í•„. ê° ì§ˆë¬¸ì„ ëª…í™•ížˆ êµ¬ë¶„í•˜ì—¬ ì½ê¸° íŽ¸í•˜ê²Œ êµ¬ì„±.",
        format: "ê° ë¬¸ë‹¨ë§ˆë‹¤ 'â—† Q1:', 'â—† Q2:', 'â—† Q3:' í˜•íƒœë¡œ ì§ˆë¬¸ì„ ëª…ì‹œí•˜ê³  ê·¸ì— ëŒ€í•œ ë‹µë³€ì„ ì œê³µ. ì˜ë¬¸ ì „ê³µëª… ë³‘ê¸°. í‚¤ì›Œë“œ SEO ë°°ì¹˜(ì§ˆë¬¸/ë‹µë³€ ì „ë°˜). í•™ì›ì˜ ì‹¤ë¬´ ê²½í—˜ê³¼ ì„±ê³¼ ì–¸ê¸‰. ê°ì‚¬ì¸ì‚¬ì™€ ì¶”ì²œ ë©”ì‹œì§€ëŠ” í¬í•¨í•˜ì§€ ì•ŠìŒ.",
        examples: "ì£¼ì œì—ì„œ íŒŒìƒëœ 3ê°€ì§€ ì£¼ìš” ì§ˆë¬¸ê³¼ ê·¸ì— ëŒ€í•œ ì¹œê·¼í•œ ë‹µë³€, ì •ë³´ì™€ ê³µê°ì´ ì–´ìš°ëŸ¬ì§„ ì„¤ëª…, ë‹¤ì–‘í•œ ë¬¸ìž¥ êµ¬ì¡°, í•™ì›ì˜ êµìœ¡ ì„±ê³¼ ì‚¬ë¡€"
      },
      general: {
        structure: {
          paragraph1: "ë…ìž ì°¸ì—¬ ì§ˆë¬¸ìœ¼ë¡œ ì‹œìž‘ - 'ì—¬ëŸ¬ë¶„ì€ ~ì¸ê°€ìš”?' ë“±ìœ¼ë¡œ ì‹œìž‘í•˜ê³ , í‚¤ì›Œë“œë¥¼ ì¸ì‚¬ë§ì— ìžì—°ìŠ¤ëŸ½ê²Œ í¬í•¨. ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ì¹œê·¼í•œ ì¸ì‚¬ì™€ ì£¼ì œ ì†Œê°œ. í•™ì›ì˜ ì „ë¬¸ì„±ì„ ê°„ì ‘ì ìœ¼ë¡œ ì–´í•„. ì§§ì€ ë¬¸ìž¥ê³¼ ê¸´ ë¬¸ìž¥ í˜¼ìš©ìœ¼ë¡œ ë¦¬ë“¬ê° ì¡°ì„± (300-350ìž)",
          paragraph2: "í¥ë¯¸ë¡­ê³  ì¹œê·¼í•œ ì„¤ëª… - í‚¤ì›Œë“œë¥¼ ë³¸ë¬¸ ì¤‘ê°„ì— ë°˜ë³µ ë°°ì¹˜. ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ì‹œê°ì  ë¬˜ì‚¬, ê°œì¸ì  ê²¬í•´, ì‰¬ìš´ ì„¤ëª… ì œê³µ. í•™ì›ì˜ êµìœ¡ ë°©ì‹ê³¼ í•™ìƒë“¤ì˜ ì„±ìž¥ ìŠ¤í† ë¦¬ ì–¸ê¸‰. ê°•ì¡° í‘œí˜„ê³¼ êµ¬ì–´ì²´ ì ì ˆížˆ í™œìš©. ì˜ë¬¸ ì „ê³µëª… ë³‘ê¸° (350-400ìž)",
          paragraph3: "ë…ìž ì°¸ì—¬ ìœ ë„ ë§ˆë¬´ë¦¬ - í‚¤ì›Œë“œë¥¼ ë§ˆë¬´ë¦¬ì— ìž¬ê°•ì¡°í•˜ì—¬ SEO íš¨ê³¼ ê·¹ëŒ€í™”. í•™ì›ì˜ ì°¨ë³„í™”ëœ ì„œë¹„ìŠ¤ì™€ ê°œë³„ ë§žì¶¤ ì§€ë„ ì–´í•„. ì´ëª¨ì§€ ì‚¬ìš©, ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ì§ˆë¬¸ ë˜ì§€ê¸°, íŒ”ë¡œìš° ìœ ë„. ë‹¤ì–‘í•œ ë¬¸ìž¥ êµ¬ì¡°ë¡œ ë‹¨ì¡°ë¡œì›€ ë°©ì§€ (250-300ìž)"
        },
        tone: "ì¹œêµ¬ê°€ ëŒ€í™”í•˜ë“¯ ì¹œê·¼í•˜ê³  íŽ¸ì•ˆí•œ í†¤. ì§§ì€ ë¬¸ìž¥ê³¼ ê¸´ ë¬¸ìž¥ì„ í˜¼ìš©í•˜ì—¬ ë¦¬ë“¬ê° ì¡°ì„±. ê°•ì¡° í‘œí˜„ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆížˆ ì„žì–´ ë‹¨ì¡°ë¡œì›€ ë°©ì§€. í•™ì›ì˜ ë”°ëœ»í•œ êµìœ¡ ì² í•™ê³¼ í•™ìƒ ì¤‘ì‹¬ ì ‘ê·¼ë²•ì„ ìžì—°ìŠ¤ëŸ½ê²Œ ì–´í•„. ê° ë¬¸ë‹¨ ë‚´ì— ì†Œì œëª©ì„ í¬í•¨í•˜ì—¬ ì½ê¸° íŽ¸í•˜ê²Œ êµ¬ì„±. ë…ìžì™€ì˜ ì†Œí†µì„ ì¤‘ì‹œí•˜ë©° í¥ë¯¸ë¡œìš´ ìŠ¤í† ë¦¬í…”ë§ ë°©ì‹.",
        format: "ë…ìž ì§ˆë¬¸ìœ¼ë¡œ ì‹œìž‘, ì´ëª¨ì§€ ì ê·¹ í™œìš© (ðŸ§˜ðŸ»â€â™€ï¸, ðŸ’­, ðŸ“), ê° ë¬¸ë‹¨ ë‚´ì— ì†Œì œëª© í¬í•¨, ì˜ë¬¸ ì „ê³µëª… ë³‘ê¸°, í‚¤ì›Œë“œ SEO ë°°ì¹˜(ì‹œìž‘/ì¤‘ê°„/ë§ˆë¬´ë¦¬), í•™ì›ì˜ êµìœ¡ ì„±ê³¼ì™€ í•™ìƒ ì¼€ì–´ ì‹œìŠ¤í…œ ì–¸ê¸‰, ëŒ“ê¸€ ì°¸ì—¬ ìœ ë„, íŒ”ë¡œìš° ìœ ë„ ë©˜íŠ¸",
        examples: "ê°œì¸ì  ê²½í—˜ë‹´, í¥ë¯¸ë¡œìš´ ì´ì•¼ê¸°, ì‹œê°ì  ì„¤ëª…, ë…ìžì™€ì˜ ì†Œí†µ, ë‹¤ì–‘í•œ ë¬¸ìž¥ êµ¬ì¡°, í•™ì›ì˜ êµìœ¡ ì² í•™ê³¼ ì„±ê³¼ ì‚¬ë¡€"
      }
    };

    const selectedType = contentTypePrompts[contentType as keyof typeof contentTypePrompts];
    
    const structuredPrompt = `
ë‹¹ì‹ ì€ í•œêµ­ì˜ ì˜ˆìˆ /ë””ìžì¸ ìœ í•™ ì „ë¬¸ í•™ì›ì—ì„œ ë¸”ë¡œê·¸ ì½˜í…ì¸ ë¥¼ ìž‘ì„±í•˜ëŠ” ì „ë¬¸ê°€ìž…ë‹ˆë‹¤.
ë„¤ì´ë²„ ë¸”ë¡œê·¸ SEO ìµœì í™”ì™€ í•™ì› í™ë³´ë¥¼ ìœ„í•œ ì½˜í…ì¸ ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.

**SEO í‚¤ì›Œë“œ ìµœì í™” ì „ëžµ:**
- ì„ íƒëœ í‚¤ì›Œë“œë“¤ì„ ë¬¸ìž¥ ì„œë‘, ì¤‘ê°„, ê²°ë¡  ë¶€ë¶„ì— ìžì—°ìŠ¤ëŸ½ê²Œ ë°˜ë³µ ë°°ì¹˜
- ì˜ˆ: "ë¯¸êµ­ ë””ìžì¸ìŠ¤ì¿¨ íŽ¸ìž… í¬íŠ¸í´ë¦¬ì˜¤ ìˆ˜ì—…"ê³¼ ê°™ì€ í‚¤ì›Œë“œ ì¡°í•©ì„ ê° ë¬¸ë‹¨ì—ì„œ ë³€í˜•í•˜ì—¬ ì‚¬ìš©
- í‚¤ì›Œë“œ ë°€ë„ë¥¼ ë†’ì´ë˜ ìžì—°ìŠ¤ëŸ¬ìš´ ë¬¸ë§¥ ìœ ì§€

**í•™ì› ì–´í•„ í¬ì¸íŠ¸:**
- ì‹¤ì œ í•©ê²© ì‚¬ë¡€ì™€ ì„±ê³µë¥  ë°ì´í„° ì–¸ê¸‰
- í•™ìƒë“¤ì˜ ì‹¤ë ¥ í–¥ìƒê³¼ ì„±ìž¥ ìŠ¤í† ë¦¬ í¬í•¨
- ì°¨ë³„í™”ëœ ì»¤ë¦¬í˜ëŸ¼ê³¼ ê°œì¸ë³„ ë§žì¶¤ ì§€ë„ ë°©ì‹ ê°•ì¡°
- ì „ë¬¸ ê°•ì‚¬ì§„ì˜ ì‹¤ë¬´ ê²½í—˜ê³¼ ì—…ê³„ ë„¤íŠ¸ì›Œí¬ ì–´í•„
- ì²´ê³„ì ì¸ í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œê³¼ ì‚¬í›„ ê´€ë¦¬ ì„œë¹„ìŠ¤ ì–¸ê¸‰

**ì¹´í…Œê³ ë¦¬:** ${category}
**ì„ íƒëœ í‚¤ì›Œë“œ:** ${keywordString}
**ì½˜í…ì¸  íƒ€ìž…:** ${contentType}
**ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸:** ${prompt}

**ì½˜í…ì¸  íƒ€ìž…ë³„ ìš”êµ¬ì‚¬í•­:**
${JSON.stringify(selectedType, null, 2)}

**ì¶œë ¥ í˜•ì‹:**
ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "title": "SEO ìµœì í™”ëœ ì œëª© (í‚¤ì›Œë“œ í¬í•¨, 30ìž ì´ë‚´)",
  "paragraph1": "ì²« ë²ˆì§¸ ë¬¸ë‹¨ì˜ ì‹¤ì œ ë‚´ìš©",
  "paragraph2": "ë‘ ë²ˆì§¸ ë¬¸ë‹¨ì˜ ì‹¤ì œ ë‚´ìš©",
  "paragraph3": "ì„¸ ë²ˆì§¸ ë¬¸ë‹¨ì˜ ì‹¤ì œ ë‚´ìš©",
  "images": ["ì´ë¯¸ì§€ ì„¤ëª… 1", "ì´ë¯¸ì§€ ì„¤ëª… 2", "ì´ë¯¸ì§€ ì„¤ëª… 3", "ì´ë¯¸ì§€ ì„¤ëª… 4", "ì´ë¯¸ì§€ ì„¤ëª… 5"],
  "hashtags": [
    "#í•´ì‹œíƒœê·¸1", "#í•´ì‹œíƒœê·¸2", "#í•´ì‹œíƒœê·¸3", "#í•´ì‹œíƒœê·¸4", "#í•´ì‹œíƒœê·¸5",
    "#í•´ì‹œíƒœê·¸6", "#í•´ì‹œíƒœê·¸7", "#í•´ì‹œíƒœê·¸8", "#í•´ì‹œíƒœê·¸9", "#í•´ì‹œíƒœê·¸10"
  ]
}

**ì¤‘ìš” ì§€ì¹¨:**
1. í‚¤ì›Œë“œë¥¼ ê° ë¬¸ë‹¨ì—ì„œ ìžì—°ìŠ¤ëŸ½ê²Œ ë°˜ë³µí•˜ì—¬ SEO íš¨ê³¼ ê·¹ëŒ€í™”
2. í•™ì›ì˜ ì „ë¬¸ì„±ê³¼ ì‹¤ì œ ì„±ê³¼ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì–´í•„
3. ë¬¸ìž¥ êµ¬ì¡°ë¥¼ ë‹¤ì–‘í™”í•˜ì—¬ ì½ê¸° ì‰½ê²Œ ìž‘ì„±
4. ë„¤ì´ë²„ ë¸”ë¡œê·¸ íŠ¹ì„±ì— ë§žëŠ” ì¹œê·¼í•˜ê³  ìœ ìš©í•œ ì •ë³´ ì œê³µ
5. ì„ íƒëœ ì½˜í…ì¸  íƒ€ìž…ì˜ í†¤ê³¼ í˜•ì‹ì„ ì •í™•ížˆ ì¤€ìˆ˜
`;

    const enhancedPrompt = structuredPrompt;

    // Initialize the Gemini AI
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

    // Generate content
    const result = await model.generateContent(enhancedPrompt);
    const response = await result.response;
    const text = response.text();

    // Parse JSON response
    try {
      // Clean up the response text to extract JSON
      let jsonText = text.trim();
      
      // Remove any markdown code block markers
      jsonText = jsonText.replace(/```json\s*/g, '').replace(/```\s*/g, '');
      
      // Find JSON content between braces
      const jsonStart = jsonText.indexOf('{');
      const jsonEnd = jsonText.lastIndexOf('}') + 1;
      
      if (jsonStart !== -1 && jsonEnd > jsonStart) {
        jsonText = jsonText.substring(jsonStart, jsonEnd);
      }
      
      const structuredContent = JSON.parse(jsonText);
      
      // Validate required fields
      if (!structuredContent.title || !structuredContent.paragraph1 || !structuredContent.paragraph2 || !structuredContent.paragraph3 || !structuredContent.images || !structuredContent.hashtags) {
        throw new Error('Missing required fields in structured content');
      }
      
      return NextResponse.json({
        title: structuredContent.title,
        paragraph1: structuredContent.paragraph1,
        paragraph2: structuredContent.paragraph2,
        paragraph3: structuredContent.paragraph3,
        images: structuredContent.images,
        hashtags: structuredContent.hashtags
      });
      
    } catch (parseError) {
      console.error('JSON parsing failed, returning raw text:', parseError);
      
      // Fallback to raw text if JSON parsing fails
      return NextResponse.json({ 
        content: text,
        isStructured: false,
        error: 'Structured parsing failed, showing raw content'
      });
    }
  } catch (error) {
    console.error('Error generating content:', error);
    return NextResponse.json(
      { error: 'Failed to generate content' },
      { status: 500 }
    );
  }
} 